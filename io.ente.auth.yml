app-id: io.ente.auth
runtime: org.gnome.Platform
runtime-version: '49'
sdk: org.gnome.Sdk
command: enteauth
finish-args:
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  # Flutter needs GPU permission.
  - --device=dri
  # For exporting codes or logs
  - --filesystem=xdg-download
  # Needs to talk to the network for authentication
  - --share=network
  # For desktop notifications
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.kde.StatusNotifierWatcher
  # Required to access secrets from the secrets portal
  - --talk-name=org.freedesktop.secrets
  # For fingerprint authentication
  - --system-talk-name=net.reactivated.Fprint
  - --env=LD_LIBRARY_PATH=/app/lib
rename-appdata-file: enteauth.appdata.xml
rename-desktop-file: enteauth.desktop
rename-icon: enteauth
cleanup:
  - '*.a'
  - '*.la'
  - /include
  - /lib/pkgconfig
  - /share/help
  - /share/man
  - /share/vala
modules:
  - shared-modules/libappindicator/libappindicator-gtk3-12.10.json
  - shared-modules/libsoup/libsoup-2.4.json

  - name: libsodium
    sources:
      - type: archive
        url: https://github.com/jedisct1/libsodium/archive/1.0.20-FINAL.tar.gz
        sha256: 2988e324bef4c7833e613322fe81c3bbd1679204da7017c948039568a7a352a5
        x-checker-data:
          type: anitya
          project-id: 1728
          url-template: https://github.com/jedisct1/libsodium/archive/$version.tar.gz

  - name: fprintd
    buildsystem: simple
    sources:
      - type: git
        url: https://gitlab.freedesktop.org/libfprint/fprintd.git
        tag: v1.94.5
        commit: b54a007ccf58ac0ae074c7151b223f35cbd17306
        x-checker-data:
          type: git
          url: https://gitlab.freedesktop.org/libfprint/fprintd.git
          tag-pattern: ^v([\d.]+)$
    build-commands:
      - meson setup builddir --prefix=${FLATPAK_DEST} -Dpam=false -Dman=false -Dsystemd=false
      - ninja -C builddir
      - install -Dm755 builddir/utils/fprintd-verify ${FLATPAK_DEST}/bin/fprintd-verify
      - install -Dm755 builddir/utils/fprintd-list ${FLATPAK_DEST}/bin/fprintd-list
    modules:
      - name: libgusb
        buildsystem: meson
        config-opts:
          - -Dtests=false
          - -Dtests=false
          - -Ddocs=false
        sources:
          - type: git
            url: https://github.com/hughsie/libgusb.git
            tag: 0.4.9
            commit: ed31c8134d80d006bd45450e84180be2a7c0742e
            x-checker-data:
              type: git
              url: https://github.com/hughsie/libgusb.git
              tag-pattern: ^([\d.]+)$


      - name: libfprint
        buildsystem: meson
        config-opts:
          - -Dudev_hwdb=disabled
          - -Dudev_rules=disabled
          - -Ddoc=false
          - -Dinstalled-tests=false
        sources:
          - type: git
            url: https://gitlab.freedesktop.org/libfprint/libfprint.git
            tag: v1.94.10
            commit: 0c97a47d8ef405cd577b87058c1e89cae9d242e7
            x-checker-data:
              type: git
              url: https://gitlab.freedesktop.org/libfprint/libfprint.git
              tag-pattern: ^v([\d.]+)$

      - name: zenity
        buildsystem: meson
        sources:
          - type: archive
            url: https://download.gnome.org/sources/zenity/4.0/zenity-4.0.3.tar.xz
            sha256: b429d97b87bd9ce7fb72ac0b78df534725d8ad39817ddca6a4ca2ee5381b08de
  - name: enteauth
    buildsystem: simple
    build-commands:
      - ln -s /app/lib/libappindicator3.so /app/lib/libayatana-appindicator3.so.1
      - ln -s /app/lib/libappindicator3.so /app/lib/libayatana-indicator3.so.7
      - ln -s /app/lib/libappindicator3.so /app/lib/libayatana-ido3-0.4.so.0
      - bsdtar --to-stdout -xf ente-auth.deb data.* | bsdtar -xf -
      - cp -a usr/share/. ${FLATPAK_DEST}/share/ && rm -rf usr/share
      - sed -i '21d' ${FLATPAK_DEST}/share/metainfo/enteauth.appdata.xml
      - ARCH_TRIPLE=$(gcc --print-multiarch) && ln -s /usr/lib/${ARCH_TRIPLE}/libsqlite3.so.0
        ${FLATPAK_DEST}/lib/libsqlite3.so
      - ln -s ${FLATPAK_DEST}/share/enteauth/enteauth ${FLATPAK_DEST}/bin/enteauth
    sources:
      - type: file
        only-arches:
          - x86_64
        url: https://github.com/ente-io/ente/releases/download/auth-v4.4.17/ente-auth-v4.4.17-x86_64.deb
        sha256: 4f3bcde329da4d1226dd4532a833b1989ad2cd49faad1123365d5438ed31c7ef
        dest-filename: ente-auth.deb
        x-checker-data:
          type: json
          url: https://api.github.com/repos/ente-io/ente/releases
          version-query: '[.[] | select(.draft == false and (.tag_name | startswith("auth-v"))
            and .prerelease == false)][0].tag_name | sub("^auth-v"; "")'
          url-query: '"https://github.com/ente-io/ente/releases/download/auth-v" +
            $version + "/ente-auth-v" + $version + "-x86_64.deb"'
